<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fragment+Mono:ital@0;1&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="favicon.png" type="image/x-icon">
    <script src="https://unpkg.com/tone@latest/build/Tone.js"></script>
    <title>instrument</title>
</head>

<body id="instrument-container">

  <label for="key" style="text-align: center;">Key</label>
  <div class="button-group" style="margin-top: 0;">
    <button class="key-btn">C</button><button class="key-btn">C#</button><button class="key-btn">D</button>
    <button class="key-btn">D#</button><button class="key-btn">E</button><button class="key-btn">F</button>
    <button class="key-btn">F#</button><button class="key-btn">G</button><button class="key-btn">G#</button>
    <button class="key-btn">A</button><button class="key-btn">A#</button><button class="key-btn">B</button>
  </div>

  <label for="scale" style="text-align: center;">Scale</label>
  <div class="button-group" style="margin-top: 0;">
    <button class="scale-btn">Major</button>
    <button class="scale-btn">Minor</button>
  </div>

  <div id="current-selection">C Major</div>

  <button id="toggle">Start Drone</button>

  <script>
    const scales = {
      major: [0, 2, 4, 5, 7, 9],
      minor: [0, 2, 3, 5, 7, 8, 10]
    };

    let selectedKey = "C";
    let selectedScale = "major";
    let rootSynth, intervalId, droneActive = false;
    const activeNotes = new Map();

    const reverb = new Tone.Reverb({ decay: 3, wet: 1 }).toDestination();
    // const delay = new Tone.FeedbackDelay({ delayTime: "8n", feedback: 0.3, wet: 0.6 }).toDestination();

    function getScaleNotes() {
      return scales[selectedScale].map(i => Tone.Frequency(`${selectedKey}3`).transpose(i).toNote());
    }

    function updateCurrentSelection() {
      document.getElementById('current-selection').textContent = `${selectedKey} ${selectedScale.charAt(0).toUpperCase() + selectedScale.slice(1)}`;
    }

    async function startDrone() {
      await Tone.start();
      droneActive = true;
      const notes = getScaleNotes();

      rootSynth = new Tone.PolySynth({
        maxPolyphony: 5,
        options: { oscillator: { type: 'triangle' } }
      }).connect(reverb);

      rootSynth.volume.value = -Infinity;  // Start muted
      rootSynth.triggerAttack([notes[0]]);

      // Fade in over 1 second to -6 dB
      rootSynth.volume.linearRampTo(-6, 1);

      let lastPlayedIndex = 0;

      intervalId = setInterval(() => {
        if (!droneActive) return;

        const availableNotes = notes.slice(1);
        const rangeStart = Math.max(0, lastPlayedIndex - 2);
        const rangeEnd = Math.min(availableNotes.length - 1, lastPlayedIndex + 2);

        const possibleNotes = availableNotes.slice(rangeStart, rangeEnd + 1);

        const randomNote = possibleNotes[Math.floor(Math.random() * possibleNotes.length)];
        const newIndex = availableNotes.indexOf(randomNote);

        if (activeNotes.has(randomNote)) {
          rootSynth.triggerRelease(randomNote);
          activeNotes.delete(randomNote);
          } else if (activeNotes.size < 2) {
          // Create a smooth fade-in using GainNode
          const gain = new Tone.Gain(0).toDestination();
          rootSynth.connect(gain);
          gain.gain.linearRampTo(1, 1); // 1-second fade-in

          rootSynth.triggerAttack(randomNote);
          activeNotes.set(randomNote, { gainNode: gain, note: randomNote });
          lastPlayedIndex = newIndex;
        }
      }, 2000);
    }

    async function smoothTransition(newKey, newScale) {
      if (droneActive) {
        clearInterval(intervalId);
        rootSynth.releaseAll();
        activeNotes.clear();
        await startDrone();
      }
    }

    document.getElementById('toggle').addEventListener('click', async function () {
      if (this.textContent === 'Start Drone') {
        await startDrone();
        this.textContent = 'Stop Drone';
      } else {
        clearInterval(intervalId);
        rootSynth.releaseAll();
        this.textContent = 'Start Drone';
        droneActive = false;
      }
    });

    document.querySelectorAll('.key-btn').forEach(btn => btn.addEventListener('click', () => {
      selectedKey = btn.textContent;
      updateCurrentSelection();
      smoothTransition(selectedKey, selectedScale);
    }));

    document.querySelectorAll('.scale-btn').forEach(btn => btn.addEventListener('click', () => {
      selectedScale = btn.textContent.toLowerCase();
      updateCurrentSelection();
      smoothTransition(selectedKey, selectedScale);
    }));

    updateCurrentSelection();
  </script>
</body>
</html>
