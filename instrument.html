<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fragment+Mono:ital@0;1&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="favicon.png" type="image/x-icon">
    <script src="https://unpkg.com/tone@latest/build/Tone.js"></script>
    <title>instrument</title>
</head>

<body id="instrument-container">

  <label for="key" style="text-align: center;">Key</label>
  <div class="button-group" style="margin-top: 0;">
    <button class="key-btn">C</button><button class="key-btn">C#</button><button class="key-btn">D</button>
    <button class="key-btn">D#</button><button class="key-btn">E</button><button class="key-btn">F</button>
    <button class="key-btn">F#</button><button class="key-btn">G</button><button class="key-btn">G#</button>
    <button class="key-btn">A</button><button class="key-btn">A#</button><button class="key-btn">B</button>
  </div>

  <!-- <label for="scale" style="text-align: center;">Scale</label>
  <div class="button-group" style="margin-top: 0;">
    <button class="scale-btn">Major</button>
    <button class="scale-btn">Minor</button>
  </div> -->

  <div id="current-selection">C</div>

  <button id="toggle">Start Drone</button>

  <script>
    const keys = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    let currentKey = "C";
    let isPlaying = false;

    const rootNote = () => `${currentKey}3`;

    // Create synths
    const fmSynth = new Tone.FMSynth().toDestination();
    const monoSynth = new Tone.MonoSynth().toDestination();
    const polySynth = new Tone.PolySynth().toDestination();

    // Create gain nodes for each synth with low starting volume
    const fmGain = new Tone.Gain(0).toDestination();
    const monoGain = new Tone.Gain(0).toDestination();
    const polyGain = new Tone.Gain(0).toDestination();

    fmSynth.connect(fmGain);
    monoSynth.connect(monoGain);
    polySynth.connect(polyGain);

    async function startDrone() {
      await Tone.start();
      const note = rootNote();

      fmSynth.triggerAttack(note);
      monoSynth.triggerAttack(note);
      polySynth.triggerAttack(note);

      const now = Tone.now();
      fmGain.gain.cancelAndHoldAtTime(now);
      monoGain.gain.cancelAndHoldAtTime(now);
      polyGain.gain.cancelAndHoldAtTime(now);
      fmGain.gain.linearRampToValueAtTime(0.3, now + 5);
      monoGain.gain.linearRampToValueAtTime(0.2, now + 5);
      polyGain.gain.linearRampToValueAtTime(0.2, now + 5);
    }

    function stopDrone() {
      const now = Tone.now();
      fmGain.gain.cancelAndHoldAtTime(now);
      monoGain.gain.cancelAndHoldAtTime(now);
      polyGain.gain.cancelAndHoldAtTime(now);
      fmGain.gain.linearRampToValueAtTime(0, now + 5);
      monoGain.gain.linearRampToValueAtTime(0, now + 5);
      polyGain.gain.linearRampToValueAtTime(0, now + 5);

      setTimeout(() => {
        fmSynth.triggerRelease(rootNote());
        monoSynth.triggerRelease(rootNote());
        polySynth.triggerRelease(rootNote());
      }, 5200);
    }

    document.querySelectorAll('.key-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        currentKey = btn.textContent;
        document.getElementById('current-selection').textContent = `${currentKey}`;
        if (isPlaying) {
          stopDrone();
          setTimeout(startDrone, 5200);
        }
      });
    });

    document.getElementById('toggle').addEventListener('click', () => {
      isPlaying = !isPlaying;
      document.getElementById('toggle').textContent = isPlaying ? "Stop Drone" : "Start Drone";
      if (isPlaying) {
        startDrone();
      } else {
        stopDrone();
      }
    });
  </script>
</body>
</html>
